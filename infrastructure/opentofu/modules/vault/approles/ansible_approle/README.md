# Vault Ansible AppRole Module

This Terraform module creates a Vault AppRole specifically for Ansible automation. It configures a Vault policy granting Ansible access to secrets stored in a structured manner.

## Purpose

The AppRole created by this module allows Ansible to securely authenticate with HashiCorp Vault and retrieve necessary secrets for configuration management and deployments.

## Vault Path Structure

This AppRole is configured to grant access to secrets under the following base path in Vault's KVv2 secrets engine (assuming it's mounted at `secret/`):

-   **Base Path for Ansible Secrets:** `secret/data/ansible/`

Within this base path, secrets are expected to be organized as follows:

-   **Machine-Specific Secrets:** `secret/data/ansible/machines/<instance_name>/`
    -   Example: `secret/data/ansible/machines/webserver-01/`
-   **Cluster-Specific Secrets:** `secret/data/ansible/clusters/<cluster_name>/`
    -   Example: `secret/data/ansible/clusters/kubernetes-prod/`

## Path Examples

Here are some concrete examples of full secret paths, assuming a KVv2 secrets engine mounted at `secret/`:

1.  **Solo Machine - Nginx SSL Certificate:**
    *   Machine Name: `web-prod-01`
    *   Secret Name: `nginx_ssl_certificate`
    *   Full Path: `secret/data/ansible/machines/web-prod-01/nginx_ssl_certificate`

2.  **Solo Machine - Service Account Username:**
    *   Machine Name: `app-dev-03`
    *   Secret Name (for a specific username): `service_accounts/svc_deployer_username`
    *   Full Path: `secret/data/ansible/machines/app-dev-03/service_accounts/svc_deployer_username`
    *   *(Alternatively, if the secret `service_accounts` stores multiple fields, the path would be `secret/data/ansible/machines/app-dev-03/service_accounts` and you would retrieve the specific field `svc_deployer_username` from it.)*

3.  **Cluster - Admin Username:**
    *   Cluster Name: `k8s-staging`
    *   Secret Name: `admin_username`
    *   Full Path: `secret/data/ansible/clusters/k8s-staging/admin_username`

4.  **Cluster - PostgreSQL Settings:**
    *   Cluster Name: `db-cluster-prod`
    *   Secret Name: `postgres_config`
    *   Full Path: `secret/data/ansible/clusters/db-cluster-prod/postgres_config`


## Vault Policy

The Vault policy associated with this AppRole grants the following permissions:

-   Full CRUDL (Create, Read, Update, Delete, List) access to data under:
    -   `secret/data/ansible/machines/*`
    -   `secret/data/ansible/clusters/*`
-   List access to metadata under:
    -   `secret/metadata/ansible/machines/*`
    -   `secret/metadata/ansible/clusters/*`

## Outputs

-   `ansible_approle_role_id`: The RoleID for this AppRole.
-   `ansible_approle_secret_id`: The SecretID for this AppRole (if `bind_secret_id` is true and a SecretID is generated by Vault).